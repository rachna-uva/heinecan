<!DOCTYPE html>
<html lang="en">
<head> 
    <meta charset="UTF-8">
    <title>Notifications</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <!-- Sidebar -->
    <div class="d-flex" id="wrapper">
        <div class="bg-dark-grey text-white" id="sidebar">
            <h2 class="text-center p-3">Health and Safety Dashboard</h2>
            <ul class="list-unstyled px-3">
                <li><a href="index.html" class="text-white"><i class="fas fa-thermometer-half"></i> Dashboard</a></li>
                <li>
                    <a href="notifications.html" class="text-white d-flex align-items-center justify-content-between">
                      <span><i class="fas fa-cloud-sun"></i> Notifications</span>
                      <span id="notif-badge" class="badge bg-danger ms-2" style="display: none;">●</span>
                    </a>
                </li>                   
                <li><a href="rewards.html" class="text-white"><i class="fas fa-tint"></i> Rewards</a></li>
            </ul>
        </div>


    <!-- Page Content -->
    <div id="page-content-wrapper" class="p-4">
        <h1 class="mb-4">Notifications</h1>

        <!-- Auto-mitigation area -->
        <div class="mb-4">
            <h4>Suggested Mitigation Based on Today’s Heat Risk</h4>
            <div class="alert alert-info" id="mitigation-message">Loading...</div>
            <button class="btn btn-primary" id="send-mitigation">Send Notification</button>
        </div>

        <!-- Notifications List -->
        <div>
            <h4>Sent Notifications</h4>
            <div id="notification-list" class="mt-3">
                <!-- Notifications will appear here -->
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
    const mitigationBox = document.getElementById('mitigation-message');
    const sendBtn = document.getElementById('send-mitigation');
    const notificationList = document.getElementById('notification-list');
    const badge = document.getElementById("notif-badge");

    let currentMitigation = "";

    // Load mitigation from CSV using PapaParse
    function loadMitigation() {
        Papa.parse("data.csv", {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                if (!data || data.length === 0) {
                    mitigationBox.classList.replace("alert-info", "alert-danger");
                    mitigationBox.textContent = "No mitigation data available.";
                    return;
                }
                const randomRow = data[Math.floor(Math.random() * data.length)];
                currentMitigation = randomRow["Mitigation"] || "No mitigation found.";
                mitigationBox.textContent = currentMitigation;
            },
            error: function(err) {
                mitigationBox.classList.replace("alert-info", "alert-danger");
                mitigationBox.textContent = "Failed to load mitigation suggestion.";
                console.error("PapaParse error:", err);
            }
        });
    }

    // Save notification to localStorage
    function saveNotification(message) {
        const existing = JSON.parse(localStorage.getItem('notifications')) || [];
        existing.push(message);
        localStorage.setItem('notifications', JSON.stringify(existing));
    }

    // Display notification on screen
    function displayNotification(message) {
        const alert = document.createElement('div');
        alert.className = 'alert alert-warning';
        alert.textContent = message;
        notificationList.prepend(alert);
    }

    // Send current mitigation as notification
    sendBtn.addEventListener('click', () => {
        if (currentMitigation) {
            saveNotification(currentMitigation);
            displayNotification(currentMitigation);

            // Show badge on sidebar
            if (badge) badge.style.display = "none";
            localStorage.removeItem('notifications');
        }
    });

    // Load existing notifications and mitigation on page load
    window.addEventListener('DOMContentLoaded', () => {
        const saved = JSON.parse(localStorage.getItem('notifications')) || [];
        saved.forEach(displayNotification);

        // Show badge if there are notifications
        if (saved.length > 0 && badge) {
            badge.style.display = "inline-block";
        }

        loadMitigation();
    });
</script>

</body>
</html>
